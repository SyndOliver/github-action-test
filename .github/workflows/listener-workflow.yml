# listener-workflow.yml
name: Listener Workflow

on:
  workflow_run:
    workflows: ["Main Workflow"]  # Ph·∫£i kh·ªõp v·ªõi t√™n trong main workflow
    types:
      - completed

jobs:
  check-status:
    runs-on: Linux
    steps:
      - name: Download artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: main-workflow.yml  # T√™n file workflow
          run_id: ${{ github.event.workflow_run.id }}
          name: job1-status
          path: ./status
      
      - name: Check status from artifact
        run: |
          if [ -f ./status/job1-status.txt ]; then
            STATUS=$(cat ./status/job1-status.txt)
            echo "Job1 Status: $STATUS"
            
            if [ "$STATUS" == "timeout" ]; then
              echo "üïê Job1 b·ªã TIMEOUT"
            elif [ "$STATUS" == "failed" ]; then
              echo "‚ùå Job1 b·ªã FAIL"
            else
              echo "‚úÖ Job1 SUCCESS"
            fi
          else
            echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y status file"
          fi
      
      - name: Check status using API (backup method)
        uses: actions/github-script@v7
        with:
          script: |
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            for (const job of jobs.jobs) {
              if (job.name === 'job1') {
                console.log('=== Job1 Analysis ===');
                console.log(`Conclusion: ${job.conclusion}`);
                
                if (job.conclusion === 'timed_out') {
                  console.log('üïê TIMEOUT via API');
                } else if (job.conclusion === 'failure') {
                  console.log('‚ùå FAILURE via API');
                } else {
                  console.log('‚úÖ SUCCESS via API');
                }
              }
            }