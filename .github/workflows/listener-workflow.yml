# listener-workflow.yml
name: Listener Workflow

on:
  workflow_run:
    workflows: ["Main"]
    types:
      - completed

jobs:
  detect-type:
    runs-on: Linux
    outputs:
      is_failure: ${{ steps.check.outputs.is_failure }}
      is_timeout: ${{ steps.check.outputs.is_timeout }}
    steps:
      - name: Detect failure type
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            for (const job of jobs.jobs) {
              if (job.name === 'job1') {
                if (job.conclusion === 'cancelled') {
                  console.log('üïê TIMEOUT detected');
                  core.setOutput('is_timeout', 'true');
                  core.setOutput('is_failure', 'false');
                } else if (job.conclusion === 'failure') {
                  console.log('‚ùå FAILURE detected');
                  core.setOutput('is_failure', 'true');
                  core.setOutput('is_timeout', 'false');
                } else {
                  core.setOutput('is_failure', 'false');
                  core.setOutput('is_timeout', 'false');
                }
              }
            }
  
  # Job n√†y CH·ªà ch·∫°y khi l√† failure (kh√¥ng ph·∫£i timeout)
  handle-failure:
    runs-on: Linux
    needs: detect-type
    if: needs.detect-type.outputs.is_failure == 'true'
    steps:
      - name: Process failure
        run: |
          echo "X·ª≠ l√Ω failure case..."
          
      - name: Download failure artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: main-workflow.yml 
          run_id: ${{ github.event.workflow_run.id }}
          name: job1-status
          path: ./status
      
      - name: Send failure notification
        run: |
          echo "G·ª≠i notification v·ªÅ failure"
          # Logic notification
      
      - name: Create issue for failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Main Workflow Job1 Failed',
              body: `Job1 failed in workflow run: ${context.payload.workflow_run.html_url}`,
              labels: ['bug', 'workflow-failure']
            });
  
  # Job n√†y CH·ªà ch·∫°y khi l√† timeout (optional - n·∫øu b·∫°n mu·ªën x·ª≠ l√Ω ri√™ng)
  handle-timeout:
    runs-on: Linux
    needs: detect-type
    if: needs.detect-type.outputs.is_timeout == 'true'
    steps:
      - name: Log timeout
        run: |
          echo "Job1 b·ªã timeout - kh√¥ng c·∫ßn x·ª≠ l√Ω ƒë·∫∑c bi·ªát"